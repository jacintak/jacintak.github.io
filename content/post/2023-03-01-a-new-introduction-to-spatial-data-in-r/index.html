---
title: A new introduction to spatial data in R
author: admin
date: '2023-03-01'
slug: starting-with-terra
categories: [code]
tags: [code, R stats]
subtitle: 'Using terra and geodata'
summary: 'An updated basic workflow with rasters and spatial points using terra and geodata'
authors: []
lastmod: ''
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: yes
projects: []
---



<div id="spatial-analysis-in-r-has-changed" class="section level1">
<h1>Spatial analysis in R has changed</h1>
<p>There has been a major revamp of spatial analysis packages for R. You may find your old spatial analysis code does not work with the most recent packages. I resisted for as long as I could but alas I had to update my code with the shiny new thing.</p>
<p>This is an updated version of my previous <a href="/post/spatial-data/">blog post</a> documenting a basic workflow to query an online database of species occurrences, download rasters of climate data and extract information from the raster based on coordinates. There major change to this workflow is the package <code>terra</code> which replaces <code>raster</code>. This change has two implications for our code:</p>
<ol style="list-style-type: decimal">
<li>To get WorldClim data you need to use the package <code>geodata</code>. There are a couple of geographic datasets available, like elevation and landcover, but currently only one version of WorldClim is supported (v2.1 at the time of writing, v0.5-3).</li>
<li>We don’t need other spatial analysis packages like <code>sp</code> or <code>sf</code> for the raster manipulations we want to do. You may for more complex spatial analysis.</li>
</ol>
<hr />
</div>
<div id="the-workflow" class="section level1">
<h1>The workflow</h1>
<p>Load the two pacakges we need.</p>
<pre><code>library(terra) # Rasters!
library(rgbif) # Query GBIF
library(tidyverse) # For data processing</code></pre>
<div id="getting-gbif-data" class="section level2">
<h2>Getting GBIF data</h2>
<p>We need some species occurrence points. We can get the first 100 records from GBIF for the European House Sparrow. The code is the same as the other post, so for variety here I’ve written it as a tidyverse pipe rather than base.</p>
<pre><code>bird_points &lt;- name_suggest(q =&quot;Passer domesticus&quot;, rank=&#39;species&#39;)$data$key[1] %&gt;% 
    # Get unique key then search GBIF
    occ_search(taxonKey = ., limit = 100) %&gt;%
    # Discard the metadata
    pluck(&#39;data&#39;) %&gt;% 
    # Remove missing latitudes
    drop_na(decimalLatitude)</code></pre>
</div>
<div id="worldclim-data" class="section level2">
<h2>WorldClim data</h2>
<p>The function <code>geodata::worldclim_global</code> will get the environmental variables you want at the desired resolution. To get a single raster for global annual air temperature, we can start with the mean monthly air temperature at 10 minutes of a degree. We can then get the mean of these 12 raster layers to get annual temperature. Temperature does not appear to be multiplied by 10.</p>
<pre><code>annual_temp &lt;- geodata::worldclim_global(var = &#39;tavg&#39;, res = &#39;10&#39;, path = &#39;~&#39;)
annual_temp &lt;- mean(annual_temp) # get mean annual temperature

# Plot our raster with the GBIF records
plot(annual_temp,
     main = &#39;Mean Annual Air Temperature&#39;,
     col = viridis::viridis(n = 20))
points(bird_points$decimalLongitude, bird_points$decimalLatitude)</code></pre>
<p align="center">
<div class="figure">
<img src="featured.png" alt="" />
<p class="caption">Figure 1: Mean annual air temperature with 100 occurrence localities for the house sparrow (points).</p>
</div>
</p>
</div>
<div id="extracting-temperature-for-each-coordinate" class="section level2">
<h2>Extracting temperature for each coordinate</h2>
<p>Here’s where it really changes with <code>terra</code>. We no longer need to use <code>sp::SpatialPoints</code> with <code>terra::extract</code>. <code>terra</code> will accept a <strong>matrix</strong> of longitudes and latitudes, among other formats. Remember longitude first! <code>terra</code> has its own <code>SpatVector</code> to replace <code>SpatialPoints</code>.</p>
<p>If you like using pipes, then it’s simple to use <code>terra::extract</code> with <code>dplyr::mutate</code> within a pipe. We can do a more complex manipulation before extracting. Say we only want the temperature at the maximum and minimum latitudes:</p>
<pre><code>bird_points %&gt;% 
  # Longitude first!
  select(decimalLongitude, decimalLatitude) %&gt;% 
  # Keep the minimum and maximum latitudes
  slice(which.min(decimalLatitude),
        which.max(decimalLatitude)) %&gt;% 
  # Extract temperature at each point
  mutate(temperature = terra::extract(annual_temp, as.matrix(.))$mean)</code></pre>
<pre><code># # A tibble: 2 × 3
##   decimalLongitude decimalLatitude temperature
##              &lt;dbl&gt;           &lt;dbl&gt;       &lt;dbl&gt;
## 1             39.8            54.1        5.49
## 2             17.1            68.8        3.09</code></pre>
<p>And that gives us the maximum and minimum temperatures for the minimum and maximum latitudes of the first 100 records of the European House Sparrow on GBIF.</p>
</div>
</div>
